<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Reflow Point Name Regex Generator</title>

        <!-- PWA Meta Tags -->
        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#3b82f6" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />
        <meta name="apple-mobile-web-app-title" content="Reflow Regex" />
        <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            'dark-bg': '#1a1a1a',
                            'dark-surface': '#2d2d2d',
                            'dark-border': '#404040'
                        }
                    }
                }
            }
        </script>

        <!-- Lucide React Icons -->
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

        <style>
            .icon {
                width: 16px;
                height: 16px;
                display: inline-block;
            }
        </style>
    </head>
    <body class="bg-gray-50 dark:bg-dark-bg min-h-screen transition-colors duration-300">
        <div id="app" class="max-w-4xl mx-auto p-6">
            <div class="bg-white dark:bg-dark-surface rounded-lg shadow-lg p-6 transition-colors duration-300">
                <div class="flex justify-between items-start mb-2">
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
                        Reflow Point Name Regex Generator
                    </h1>
                    <button
                        id="theme-toggle"
                        class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200"
                        title="Toggle dark mode"
                    >
                        <i data-lucide="moon" class="icon text-gray-600 dark:text-gray-300"></i>
                    </button>
                </div>
                <p class="text-gray-600 dark:text-gray-300 mb-6">
                    Generate regex patterns for Tridium Niagara Reflow point
                    mapping. Patterns are automatically formatted for Reflow
                    (lowercase, wrapped in forward slashes).
                </p>

                <!-- Import Existing Regex Section -->
                <div class="mb-6 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4 transition-colors duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-blue-800 dark:text-blue-200">
                            Import Existing Regex (Optional)
                        </h2>
                        <button
                            id="toggle-import"
                            class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                        >
                            <i data-lucide="chevron-down" class="icon"></i>
                        </button>
                    </div>
                    <div id="import-section" class="space-y-3" style="display: none;">
                        <p class="text-sm text-blue-700 dark:text-blue-300 mb-3">
                            Have an existing regex pattern? Paste it here and we'll combine it with your new variations.
                        </p>
                        <div class="flex gap-2">
                            <input
                                id="existing-regex"
                                type="text"
                                placeholder="Paste existing regex (e.g., /discharge.*temp/ or discharge.*temp)"
                                class="flex-1 px-3 py-2 border border-blue-300 dark:border-blue-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 dark:text-gray-100 font-mono text-sm transition-colors duration-300"
                            />
                            <button
                                id="clear-import"
                                class="px-3 py-2 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-800/50 rounded-md transition-colors"
                            >
                                <i data-lucide="x" class="icon"></i>
                            </button>
                        </div>
                        <div
                            id="import-status"
                            class="text-sm"
                            style="display: none;"
                        ></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Input Section -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                            Point Name Variations
                        </h2>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Enter all the variations of your point name you want
                            to match:
                        </p>

                        <div id="point-inputs" class="space-y-2">
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    value="dat"
                                    placeholder="Enter point name variation..."
                                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300"
                                />
                                <button
                                    class="remove-btn px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors"
                                    style="display: none"
                                >
                                    <i data-lucide="trash-2" class="icon"></i>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    value="disch air temp"
                                    placeholder="Enter point name variation..."
                                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300"
                                />
                                <button
                                    class="remove-btn px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors"
                                >
                                    <i data-lucide="trash-2" class="icon"></i>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <input
                                    type="text"
                                    value="discharge air temperature"
                                    placeholder="Enter point name variation..."
                                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300"
                                />
                                <button
                                    class="remove-btn px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors"
                                >
                                    <i data-lucide="trash-2" class="icon"></i>
                                </button>
                            </div>
                        </div>

                        <button
                            id="add-btn"
                            class="flex items-center gap-2 px-4 py-2 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-md transition-colors"
                        >
                            <i data-lucide="plus" class="icon"></i>
                            Add Another Variation
                        </button>
                    </div>

                    <!-- Output Section -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                            Generated Regex
                        </h2>

                        <div class="relative">
                            <div
                                id="regex-output"
                                class="bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md p-3 font-mono text-sm min-h-[50px] flex items-center transition-colors duration-300"
                            >
                                <span class="text-gray-500 dark:text-gray-400"
                                    >Enter point names to generate
                                    regex...</span
                                >
                            </div>
                            <button
                                id="copy-btn"
                                class="absolute top-2 right-2 p-1 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                                style="display: none"
                            >
                                <i data-lucide="copy" class="icon"></i>
                            </button>
                        </div>

                        <div
                            id="copy-success"
                            class="flex items-center gap-2 text-green-600 dark:text-green-400 text-sm"
                            style="display: none"
                        >
                            <i data-lucide="check-circle" class="icon"></i>
                            Copied to clipboard!
                        </div>

                        <div
                            class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-md p-3 transition-colors duration-300"
                        >
                            <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                                Reflow Usage:
                            </h3>
                            <ol
                                class="text-sm text-blue-700 dark:text-blue-300 space-y-1 list-decimal list-inside"
                            >
                                <li>Copy the generated regex pattern</li>
                                <li>
                                    In Reflow, set the point identifier type to
                                    "Regular Expression"
                                </li>
                                <li>
                                    Paste the pattern (including the forward
                                    slashes)
                                </li>
                                <li>Test with your actual point names below</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Test Section -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 transition-colors duration-300">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">
                        Test Your Regex
                    </h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                            >
                                Test Point Names (one per line):
                            </label>
                            <textarea
                                id="test-input"
                                placeholder="discharge air temp&#10;da_temp&#10;supply air temperature&#10;mixed air temp"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 font-mono text-sm bg-white dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300"
                                rows="6"
                            ></textarea>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                            >
                                Test Results:
                            </label>
                            <div
                                id="test-results"
                                class="border border-gray-300 dark:border-gray-600 rounded-md p-3 bg-gray-50 dark:bg-gray-800 min-h-[156px] transition-colors duration-300"
                            >
                                <p class="text-gray-500 dark:text-gray-400 text-sm">
                                    Enter test strings to see results...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="mt-6 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 rounded-md p-4 transition-colors duration-300"
                >
                    <div class="flex items-start gap-2">
                        <i
                            data-lucide="alert-circle"
                            class="icon text-yellow-600 dark:text-yellow-400 mt-0.5"
                        ></i>
                        <div class="text-sm text-yellow-800 dark:text-yellow-200">
                            <p class="font-semibold mb-1">Important Notes:</p>
                            <ul class="space-y-1 list-disc list-inside">
                                <li>
                                    Reflow converts all point names to lowercase
                                    before matching
                                </li>
                                <li>
                                    Always test your regex on regex101.com
                                    before using in Reflow
                                </li>
                                <li>
                                    The generated pattern handles spaces and
                                    underscores automatically
                                </li>
                                <li>
                                    More specific patterns are generally better
                                    than overly broad ones
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Initialize Lucide icons
            lucide.createIcons();

            // App state
            let pointNames = [
                "dat",
                "disch air temp",
                "discharge air temperature",
            ];
            let generatedRegex = "";
            let importedRegex = "";
            let isDarkMode = false;

            // DOM elements
            const pointInputsContainer =
                document.getElementById("point-inputs");
            const addBtn = document.getElementById("add-btn");
            const regexOutput = document.getElementById("regex-output");
            const copyBtn = document.getElementById("copy-btn");
            const copySuccess = document.getElementById("copy-success");
            const testInput = document.getElementById("test-input");
            const testResults = document.getElementById("test-results");
            const toggleImport = document.getElementById("toggle-import");
            const importSection = document.getElementById("import-section");
            const existingRegexInput = document.getElementById("existing-regex");
            const clearImportBtn = document.getElementById("clear-import");
            const importStatus = document.getElementById("import-status");
            const themeToggle = document.getElementById("theme-toggle");

            // Utility functions
            function escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            }

            function parseImportedRegex(regexString) {
                if (!regexString.trim()) return null;
                
                try {
                    // Remove forward slashes if present
                    let cleanRegex = regexString.trim();
                    if (cleanRegex.startsWith('/') && cleanRegex.endsWith('/')) {
                        cleanRegex = cleanRegex.slice(1, -1);
                    }
                    
                    // Test if the regex is valid
                    new RegExp(cleanRegex, 'i');
                    
                    return cleanRegex;
                } catch (error) {
                    return null;
                }
            }

            function showImportStatus(message, isError = false) {
                importStatus.innerHTML = `
                    <div class="flex items-center gap-2 ${isError ? 'text-red-600' : 'text-green-600'}">
                        <i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="icon"></i>
                        ${message}
                    </div>
                `;
                importStatus.style.display = 'block';
                lucide.createIcons();
                
                if (!isError) {
                    setTimeout(() => {
                        importStatus.style.display = 'none';
                    }, 3000);
                }
            }

            function toggleImportSection() {
                const isExpanded = importSection.style.display !== 'none';
                importSection.style.display = isExpanded ? 'none' : 'block';
                const icon = toggleImport.querySelector('i');
                icon.setAttribute('data-lucide', isExpanded ? 'chevron-down' : 'chevron-up');
                lucide.createIcons();
            }

            // Theme management functions
            function initializeTheme() {
                // Check for saved theme preference or system preference
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                isDarkMode = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);
                applyTheme();
                
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        isDarkMode = e.matches;
                        applyTheme();
                    }
                });
            }

            function toggleTheme() {
                isDarkMode = !isDarkMode;
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                applyTheme();
                updateManifestThemeColor();
            }

            function applyTheme() {
                const htmlElement = document.documentElement;
                const themeIcon = themeToggle.querySelector('i');
                
                if (isDarkMode) {
                    htmlElement.classList.add('dark');
                    themeIcon.setAttribute('data-lucide', 'sun');
                    themeToggle.title = 'Switch to light mode';
                } else {
                    htmlElement.classList.remove('dark');
                    themeIcon.setAttribute('data-lucide', 'moon');
                    themeToggle.title = 'Switch to dark mode';
                }
                
                lucide.createIcons();
            }

            function updateManifestThemeColor() {
                // Update the manifest theme color dynamically
                const themeColorMeta = document.querySelector('meta[name="theme-color"]');
                const statusBarStyleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
                
                if (themeColorMeta) {
                    themeColorMeta.content = isDarkMode ? '#1a1a1a' : '#3b82f6';
                }
                
                if (statusBarStyleMeta) {
                    statusBarStyleMeta.content = isDarkMode ? 'black-translucent' : 'default';
                }
            }

            function updatePointInputs() {
                pointInputsContainer.innerHTML = "";

                pointNames.forEach((name, index) => {
                    const div = document.createElement("div");
                    div.className = "flex gap-2";

                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = name;
                    input.placeholder = "Enter point name variation...";
                    input.className =
                        "flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300";
                    input.addEventListener("input", (e) => {
                        pointNames[index] = e.target.value;
                        generateRegex();
                    });

                    const button = document.createElement("button");
                    button.className =
                        "remove-btn px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md transition-colors";
                    button.style.display =
                        pointNames.length > 1 ? "block" : "none";
                    button.innerHTML =
                        '<i data-lucide="trash-2" class="icon"></i>';
                    button.addEventListener("click", () => {
                        pointNames.splice(index, 1);
                        updatePointInputs();
                        generateRegex();
                    });

                    div.appendChild(input);
                    div.appendChild(button);
                    pointInputsContainer.appendChild(div);
                });

                lucide.createIcons();
            }

            function generateRegex() {
                const cleanNames = pointNames
                    .filter((name) => name.trim())
                    .map((name) => name.toLowerCase().trim());

                // Handle case with only imported regex and no variations
                if (cleanNames.length === 0 && importedRegex) {
                    generatedRegex = `/${importedRegex}/`;
                    regexOutput.textContent = generatedRegex;
                    copyBtn.style.display = "block";
                    testRegex();
                    return;
                }

                if (cleanNames.length === 0 && !importedRegex) {
                    generatedRegex = "";
                    regexOutput.innerHTML =
                        '<span class="text-gray-500">Enter point names to generate regex...</span>';
                    copyBtn.style.display = "none";
                    return;
                }

                let newPattern = "";

                if (cleanNames.length === 1) {
                    const name = cleanNames[0];
                    const words = name.split(/[\s_]+/).filter((word) => word);
                    newPattern = words
                        .map((word) => escapeRegex(word) + "[a-z]*")
                        .join("[\\s_]*");
                } else {
                    const allWords = cleanNames.flatMap((name) =>
                        name.split(/[\s_]+/).filter((word) => word),
                    );
                    const uniqueWords = [...new Set(allWords)];

                    // Filter common words to avoid overly broad patterns
                    const commonWords = uniqueWords.filter((word) => {
                        // Only consider words that are at least 2 characters long
                        if (word.length < 2) return false;
                        
                        // Check if word appears in all names
                        return cleanNames.every((name) => name.includes(word));
                    });

                    // Calculate pattern specificity to avoid overly broad matches
                    const calculateSpecificity = (words) => {
                        return words.reduce((score, word) => score + word.length, 0);
                    };

                    if (commonWords.length > 0 && calculateSpecificity(commonWords) >= 6) {
                        // Only use common words if they provide sufficient specificity
                        const sortedCommon = commonWords.sort((a, b) => {
                            const orderMap = {
                                discharge: 1,
                                disch: 1,
                                da: 1,
                                supply: 2,
                                return: 3,
                                air: 4,
                                temp: 5,
                                temperature: 5,
                            };
                            return (orderMap[a] || 99) - (orderMap[b] || 99);
                        });

                        newPattern = sortedCommon
                            .map((word) => escapeRegex(word) + "[a-z]*")
                            .join("[\\s_]*");
                    } else {
                        // Fall back to alternation pattern for better specificity
                        const patterns = cleanNames.map((name) => {
                            const words = name
                                .split(/[\s_]+/)
                                .filter((word) => word.length > 0);
                            
                            // Ensure minimum pattern complexity
                            if (words.length === 1 && words[0].length < 3) {
                                return escapeRegex(words[0]);
                            }
                            
                            return words
                                .map((word) => escapeRegex(word) + "[a-z]*")
                                .join("[\\s_]*");
                        });
                        newPattern = `(${patterns.join("|")})`;
                    }
                }

                // Combine imported regex with new pattern
                if (importedRegex && newPattern) {
                    generatedRegex = `/(${importedRegex}|${newPattern})/`;
                } else if (importedRegex) {
                    generatedRegex = `/${importedRegex}/`;
                } else {
                    generatedRegex = `/${newPattern}/`;
                }

                regexOutput.textContent = generatedRegex;
                copyBtn.style.display = "block";
                testRegex();
            }

            function copyToClipboard() {
                navigator.clipboard
                    .writeText(generatedRegex)
                    .then(() => {
                        copySuccess.style.display = "flex";
                        setTimeout(() => {
                            copySuccess.style.display = "none";
                        }, 2000);
                    })
                    .catch((err) => {
                        console.error("Failed to copy text: ", err);
                    });
            }

            function testRegex() {
                if (!generatedRegex || !testInput.value.trim()) {
                    testResults.innerHTML =
                        '<p class="text-gray-500 text-sm">Enter test strings to see results...</p>';
                    return;
                }

                try {
                    const pattern = generatedRegex.slice(1, -1);
                    const regex = new RegExp(pattern, "i");

                    const testStrings = testInput.value
                        .split("\n")
                        .filter((str) => str.trim());
                    const results = testStrings.map((str) => ({
                        input: str.trim(),
                        matches: regex.test(str.toLowerCase().trim()),
                    }));

                    testResults.innerHTML = results
                        .map(
                            (result) => `
                    <div class="flex items-center gap-2 text-sm mb-2">
                        ${
                            result.matches
                                ? '<i data-lucide="check-circle" class="icon text-green-500"></i>'
                                : '<div class="w-4 h-4 rounded-full border-2 border-red-500"></div>'
                        }
                        <span class="${result.matches ? "text-green-700" : "text-red-700"}">
                            ${result.input}
                        </span>
                    </div>
                `,
                        )
                        .join("");

                    lucide.createIcons();
                } catch (error) {
                    testResults.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-red-700">
                        <i data-lucide="alert-circle" class="icon text-red-500"></i>
                        Error: ${error.message}
                    </div>
                `;
                    lucide.createIcons();
                }
            }

            // Event listeners
            addBtn.addEventListener("click", () => {
                pointNames.push("");
                updatePointInputs();
                generateRegex();
            });

            copyBtn.addEventListener("click", copyToClipboard);
            testInput.addEventListener("input", testRegex);

            toggleImport.addEventListener("click", toggleImportSection);

            existingRegexInput.addEventListener("input", (e) => {
                const parsed = parseImportedRegex(e.target.value);
                if (e.target.value.trim() === "") {
                    importedRegex = "";
                    importStatus.style.display = "none";
                    generateRegex();
                } else if (parsed) {
                    importedRegex = parsed;
                    showImportStatus("Valid regex imported successfully!");
                    generateRegex();
                } else {
                    importedRegex = "";
                    showImportStatus("Invalid regex pattern. Please check your syntax.", true);
                }
            });

            clearImportBtn.addEventListener("click", () => {
                existingRegexInput.value = "";
                importedRegex = "";
                importStatus.style.display = "none";
                generateRegex();
            });

            themeToggle.addEventListener("click", toggleTheme);

            // Initialize app
            initializeTheme();
            updatePointInputs();
            generateRegex();

            // PWA Service Worker Registration
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("./service-worker.js")
                        .then((registration) => {
                            console.log("SW registered: ", registration);
                        })
                        .catch((registrationError) => {
                            console.log(
                                "SW registration failed: ",
                                registrationError,
                            );
                        });
                });
            }
        </script>
    </body>
</html>
